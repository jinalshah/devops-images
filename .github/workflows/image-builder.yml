name: devops-image-builder

on:
  push:
    branches:
      - "main"

env:
  GIT_TAG_VERSION_MAJOR_MINOR: "1.0"
  GITLAB_ALL_DEVOPS_IMAGE_NAME: registry.gitlab.com/jinal-shah/devops/images/all-devops
  GITHUB_ALL_DEVOPS_IMAGE_NAME: ghcr.io/jinalshah/devops/images/all-devops
  DOCKERHUB_ALL_DEVOPS_IMAGE_NAME: js01/all-devops
  GITLAB_AWS_DEVOPS_IMAGE_NAME: registry.gitlab.com/jinal-shah/devops/images/aws-devops
  GITHUB_AWS_DEVOPS_IMAGE_NAME: ghcr.io/jinalshah/devops/images/aws-devops
  DOCKERHUB_AWS_DEVOPS_IMAGE_NAME: js01/aws-devops
  GITLAB_GCP_DEVOPS_IMAGE_NAME: registry.gitlab.com/jinal-shah/devops/images/gcp-devops
  GITHUB_GCP_DEVOPS_IMAGE_NAME: ghcr.io/jinalshah/devops/images/gcp-devops
  DOCKERHUB_GCP_DEVOPS_IMAGE_NAME: js01/gcp-devops
  PLATFORMS: "linux/arm64,linux/amd64"

jobs:

  all-devops:

    runs-on: ubuntu-latest

    steps:

      - name: Image Builder Prerequisites
        uses: ./actions/image-builder
        with:
          GIT_TAG_VERSION_MAJOR_MINOR: "{{ env.GIT_TAG_VERSION_MAJOR_MINOR }}"

      - name: Build and push - all-devops
        uses: docker/build-push-action@v4
        with:
          context: .
          platforms: ${{ env.PLATFORMS }}
          target: all-devops
          tags: |
            ${{ env.GITLAB_ALL_DEVOPS_IMAGE_NAME }}:latest
            ${{ env.GITLAB_ALL_DEVOPS_IMAGE_NAME }}:${{ env.DEVOPS_IMAGE_VERSION }}
            ${{ env.GITHUB_ALL_DEVOPS_IMAGE_NAME }}:latest
            ${{ env.GITHUB_ALL_DEVOPS_IMAGE_NAME }}:${{ env.DEVOPS_IMAGE_VERSION }}
            ${{ env.DOCKERHUB_ALL_DEVOPS_IMAGE_NAME }}:latest
            ${{ env.DOCKERHUB_ALL_DEVOPS_IMAGE_NAME }}:${{ env.DEVOPS_IMAGE_VERSION }}
          push: true

  aws-devops:

    runs-on: ubuntu-latest

    steps:

      - name: Image Builder Prerequisites
        uses: ./actions/image-builder
        with:
          GIT_TAG_VERSION_MAJOR_MINOR: "{{ env.GIT_TAG_VERSION_MAJOR_MINOR }}"

      - name: Build and push - aws-devops
        uses: docker/build-push-action@v4
        with:
          context: .
          platforms: ${{ env.PLATFORMS }}
          target: aws-devops
          tags: |
            ${{ env.GITLAB_AWS_DEVOPS_IMAGE_NAME }}:latest
            ${{ env.GITLAB_AWS_DEVOPS_IMAGE_NAME }}:${{ env.DEVOPS_IMAGE_VERSION }}
            ${{ env.GITHUB_AWS_DEVOPS_IMAGE_NAME }}:latest
            ${{ env.GITHUB_AWS_DEVOPS_IMAGE_NAME }}:${{ env.DEVOPS_IMAGE_VERSION }}
            ${{ env.DOCKERHUB_AWS_DEVOPS_IMAGE_NAME }}:latest
            ${{ env.DOCKERHUB_AWS_DEVOPS_IMAGE_NAME }}:${{ env.DEVOPS_IMAGE_VERSION }}
          push: true

  gcp-devops:

    runs-on: ubuntu-latest

    steps:

      - name: Image Builder Prerequisites
        uses: ./actions/image-builder
        with:
          GIT_TAG_VERSION_MAJOR_MINOR: "{{ env.GIT_TAG_VERSION_MAJOR_MINOR }}"

      - name: Build and push - gcp-devops
        uses: docker/build-push-action@v4
        with:
          context: .
          platforms: ${{ env.PLATFORMS }}
          target: gcp-devops
          tags: |
            ${{ env.GITLAB_GCP_DEVOPS_IMAGE_NAME }}:latest
            ${{ env.GITLAB_GCP_DEVOPS_IMAGE_NAME }}:${{ env.DEVOPS_IMAGE_VERSION }}
            ${{ env.GITHUB_GCP_DEVOPS_IMAGE_NAME }}:latest
            ${{ env.GITHUB_GCP_DEVOPS_IMAGE_NAME }}:${{ env.DEVOPS_IMAGE_VERSION }}
            ${{ env.DOCKERHUB_GCP_DEVOPS_IMAGE_NAME }}:latest
            ${{ env.DOCKERHUB_GCP_DEVOPS_IMAGE_NAME }}:${{ env.DEVOPS_IMAGE_VERSION }}
          push: true
