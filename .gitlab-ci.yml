variables:
  DOCKER_TLS_CERTDIR: "/certs"
  DEVOPS_IMAGE_VERSION: "1.0.$CI_COMMIT_SHORT_SHA"
  ALL_DEVOPS_IMAGE_NAME: "$CI_REGISTRY_IMAGE/all-devops"
  GHCR_ALL_DEVOPS_IMAGE_NAME: "ghcr.io/jinalshah/devops/all-devops"
  AWS_DEVOPS_IMAGE_NAME: "$CI_REGISTRY_IMAGE/aws-devops"
  GHCR_AWS_DEVOPS_IMAGE_NAME: "ghcr.io/jinalshah/devops/aws-devops"
  GCP_DEVOPS_IMAGE_NAME: "$CI_REGISTRY_IMAGE/gcp-devops"
  GHCR_GCP_DEVOPS_IMAGE_NAME: "ghcr.io/jinalshah/devops/gcp-devops"

stages:
  - all-devops-build
  - all-devops-deploy
  - aws-devops-build
  - aws-devops-deploy
  - gcp-devops-build
  - gcp-devops-deploy

#############################################################################################
all-devops-build-image:
  stage: all-devops-build

  image: 
    name: docker:latest

  services:
    - docker:dind

  only:
    refs: 
      - branches
      - tags
    changes:
      - Dockerfile
      - "*.sh"
      - .gitlab-ci.yml

  except:
    - main

  before_script:
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY
    - echo $GHCR_PASSWORD | docker login ghcr.io --username "GHCR_USER" --password-stdin
    - export TIMESTAMP=$(date +%Y%m%d-%H%M%S)

  script:
    - >
      docker build --target all-devops --pull
      -t $ALL_DEVOPS_IMAGE_NAME:latest
      -t $ALL_DEVOPS_IMAGE_NAME:$DEVOPS_IMAGE_VERSION
      -t $ALL_DEVOPS_IMAGE_NAME:$TIMESTAMP
      -t $GHCR_ALL_DEVOPS_IMAGE_NAME:latest
      -t $GHCR_ALL_DEVOPS_IMAGE_NAME:$DEVOPS_IMAGE_VERSION
      -t $GHCR_ALL_DEVOPS_IMAGE_NAME:$TIMESTAMP
      .
    - docker push $ALL_DEVOPS_IMAGE_NAME:$DEVOPS_IMAGE_VERSION
    - docker push $ALL_DEVOPS_IMAGE_NAME:$TIMESTAMP
    - docker push $GHCR_ALL_DEVOPS_IMAGE_NAME:$DEVOPS_IMAGE_VERSION
    - docker push $GHCR_ALL_DEVOPS_IMAGE_NAME:$TIMESTAMP
#############################################################################################



#############################################################################################
all-devops-deploy-image:
  stage: all-devops-deploy

  image: 
    name: docker:latest

  services:
    - docker:dind

  only:
    refs:
      - main
    changes:
      - Dockerfile
      - "*.sh"
      - .gitlab-ci.yml

  before_script:
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY
    - echo $GHCR_PASSWORD | docker login ghcr.io --username "GHCR_USER" --password-stdin
    - export TIMESTAMP=$(date +%Y%m%d-%H%M%S)

  script:
    - >
      docker build --target all-devops --pull
      -t $ALL_DEVOPS_IMAGE_NAME:latest 
      -t $ALL_DEVOPS_IMAGE_NAME:$DEVOPS_IMAGE_VERSION
      -t $ALL_DEVOPS_IMAGE_NAME:$TIMESTAMP
      -t $GHCR_ALL_DEVOPS_IMAGE_NAME:latest
      -t $GHCR_ALL_DEVOPS_IMAGE_NAME:$DEVOPS_IMAGE_VERSION
      -t $GHCR_ALL_DEVOPS_IMAGE_NAME:$TIMESTAMP
      .
    - docker push $ALL_DEVOPS_IMAGE_NAME:latest 
    - docker push $ALL_DEVOPS_IMAGE_NAME:$DEVOPS_IMAGE_VERSION
    - docker push $ALL_DEVOPS_IMAGE_NAME:$TIMESTAMP
    - docker push $GHCR_ALL_DEVOPS_IMAGE_NAME:latest
    - docker push $GHCR_ALL_DEVOPS_IMAGE_NAME:$DEVOPS_IMAGE_VERSION
    - docker push $GHCR_ALL_DEVOPS_IMAGE_NAME:$TIMESTAMP
#############################################################################################